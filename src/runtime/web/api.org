
#+TITLE: The REST API
#+AUTHOR: VLEAD
#+DATE: [2017-05-12 Fri]
#+SETUPFILE: ../../org-templates/level-2.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil'

* Introduction
  This  displays the visualization of the feedbacks given by the users


* WebApp 
** Index HTML
#+BEGIN_SRC  html :tangle templates/index.html :eval no :noweb yes
<html>
<head>
<title>Dashboard</title>

</head>
<body>
<div class="container-fluid">
<div class="col-sm-4 col-md-4 col-lg-4 col-xs-4" align="center" id="scatter"></div>
</div>
</body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="/home/osboxes/vlabs/analytics-dashboard/build/code/runtime/web/static/js/chart_display.js"></script>
<script src="/home/osboxes/Downloads/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

</html>

#+END_SRC


** JS
#+BEGIN_SRC  javascript :tangle /static/js/chart_display.js :eval no :noweb yes
var dataSet
var  dict = {}
var gap = 50

var canvas  = d3.select("#scatter").append("svg")
.attr({
  height : 1000,
  width : 500
});


$.ajax({// Ajax call for URL
    	method: 'GET',
    	url: "http://feedback-analytics.vlabs.ac.in/vlabs/feedback/_search?size=10000", // Keep URL here
    	type: 'json' // define type here
 	})
 	.done(function(data/*this is the data or response*/) {
    var i = 0
    dataSet = data// meh !! for no reason.. You can actually troubleshoot from console using this variable => scope: global

    for(var index1 = 0; index1 < dataSet["hits"]["hits"].length; index1++){  //  iterates through first lebel
      var year;
      if(typeof(dataSet["hits"]["hits"][index1]["_source"]["date"]) != "undefined" ){ // filters the undefined type to prevent stopping of execution
        year = dataSet["hits"]["hits"][index1]["_source"]["date"].split("-")[2] // extracting the year from the given date.
      }
        // if(typeof(dataSet["hits"]["hits"][index1]["_source"]["responses"]) != "undefined")
        //  for(var index2 = 0; index2dataset.max() * gap < dataSet["hits"]["hits"][index1]["_source"]["responses"].length;index2++){ // this is the secondary level for accessing the responses and questions.
            /*
             this piece of code will maintain a dictionsary with year as key and number of repetetions as values.
             In if condition you are checking whether the year is present or not. If it is true, then we have to update the value of that year by incrementing by 1(that's done  else condition)
             if year is a new entry then just intialize with 1.
            */
           if( !(year in dict)){
             dict[year] = 1
           }
           else {
             var temp = dict[year]
             temp = temp + 1
             dict[year] = temp
           }

          // console.log(dataSet["hits"]["hits"][index1]["_source"]["date"])//["responses"][index2]["answers"][0]["name"])
        //  }// end of innner for loop
    }// ennd of outer for loop

    i = 0
    var max = -1
    var maxHeight = canvas.attr("height")/2  // defines the maximum height of you grpah you are trying to plot and fit the original data.
    for (var key in dict){// loop to find the maximum number to define the scale
      if (  max < dict[key]) max = dict[key]
    }
    var difference = maxHeight/max // getting the difference to fit the original data onto new coordinate systems
    for (var index = 0; index < max;){ // adding scale to graph.
      canvas.append("text")
              .attr({
                x : 30,
                y : (max - index) * difference
              })
              //.attr("transform","scale(0.5)")
              .text(index)
              .attr("text-anchor", "end")
              index += 100 // defines the differenc between each tick and also helps to decide how many ticks.
    }
var xAxis = canvas.append("line")
.attr("x1", gap-6)
.attr("x2", (1+Object.keys(dict).length) * gap)
.attr("y1", maxHeight + 7 )
.attr("y2", maxHeight + 7)
.attr("stroke-width", 2)
.attr("stroke", "black")
//.attr("transform", " scale(0.5)");
var yAxis = canvas.append("line")
.attr("x1", gap-6)
.attr("x2", gap-6)
.attr("y1",  0)
.attr("y2", max * difference +6)
.attr("stroke-width", 2)
.attr("stroke", "black")


    for(var key in dict){
      i++;
      canvas.append("rect") // adding rectangles
             .attr("x", i * gap)
             .attr("width",gap-10)
             .attr("y",max * difference)
             .attr("height",0)
             .attr("rx",3)
             .on("mouseover", function() {d3.select(this).transition()
                                          .attr("fill", "#D02316")})
              .on("mouseout", function() {d3.select(this).transition()
                                          .attr("fill", "teal")})
             .transition()
             .duration(function(){return dict[key]/2})
            .attr({
              id : "bars-year",
              
              y : (max - dict[key]) * difference,
              width :  gap - 10,
              height :dict[key] * difference,
              fill : "teal"
            })

            canvas.append("text") 
            .attr({
              x : i * gap  ,
              y : (max * difference) + 25
            })
            .text(key)

            canvas.append("text") 
            .attr({
              x : (i * gap) + ((gap-10)/2)  ,
              y : ((max - dict[key]) * difference) +15,
              fill : "white"
            })
            .attr("text-anchor", "middle")
            .text(dict[key])

            }
    console.log(dict);
 	});



//----------------------------------------------------------------------------------
//dataSet["hits"]["hits"][0]["_source"]["responses"][0]["answers"][0]["name"]
#+END_SRC
   
   
** CSS 
#+BEGIN_SRC  css :tangle /static/css/tab.css :eval no :noweb yes
#+END_SRC


